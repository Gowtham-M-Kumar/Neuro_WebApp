{% extends 'base.html' %}
{% load static %}

{% block title %}Color Matching - Level {{ level.level }}{% endblock %}

{% block content %}
<div class="color-match-bg" style="min-height:calc(100vh - 120px);display:flex;flex-direction:column;align-items:center;justify-content:center;">
    <!-- Level Title (main heading, above game board) -->
    <div class="level-title-poki level-title-prominent">Level {{ level.level }}</div>
    <!-- Game Board Centered -->
    <div class="game-board-poki mb-2" id="gameBoard">
        {% for row in grid %}
        <div class="game-row-poki">
            {% for card in row %}
            <div class="game-card-poki"
                 data-card-id="{{ card.id }}"
                 data-color="{{ card.color }}"
                 data-name="{{ card.name }}"
                 data-row="{{ card.row }}"
                 data-col="{{ card.col }}">
                <div class="card-back-poki">
                    <i class="fas fa-palette"></i>
                </div>
                <div class="card-front-poki" style="background-color: {{ card.color }};">
                    <span class="color-name">{{ card.name }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    <!-- Slim Bar: Stats + Controls (horizontal) -->
    <div class="game-bar-poki d-flex align-items-center justify-content-center gap-3 mt-2 mb-2 flex-row flex-wrap">
        <div class="stat-poki-group d-flex flex-row align-items-center gap-3">
            <div class="stat-poki"><div class="stat-poki-label">Score</div><span id="score">0</span></div>
            <div class="stat-poki"><div class="stat-poki-label">Matches</div><span id="matches">0</span></div>
            <div class="stat-poki"><div class="stat-poki-label">Attempts</div><span id="attempts">0</span></div>
            <div class="stat-poki"><div class="stat-poki-label">Accuracy</div><span id="accuracy">0%</span></div>
            <div class="stat-poki"><div class="stat-poki-label">Time</div><span id="timer">{{ level.time_limit }}</span></div>
        </div>
        <button class="btn btn-success poki-btn" id="startBtn"><span class="duo-svg-icon me-1">{% include 'icons/play.svg' %}</span></button>
        <button class="btn btn-warning poki-btn" id="pauseBtn" disabled><span class="duo-svg-icon me-1">{% include 'icons/pause.svg' %}</span></button>
        <button class="btn btn-danger poki-btn" id="resetBtn"><span class="duo-svg-icon me-1">{% include 'icons/reset.svg' %}</span></button>
        <a href="{% url 'games:color_matching_levels' %}" class="btn btn-outline-primary poki-btn ms-2"><span class="duo-svg-icon me-1">{% include 'icons/progress.svg' %}</span></a>
    </div>
</div>

<style>
.color-match-bg {
    background: linear-gradient(135deg, #e0f7fa 0%, #f3e7ff 100%);
    min-height: 100vh;
    width: 100vw;
    position: relative;
    z-index: 1;
}
.game-board-poki {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    padding: 0;
    background: none;
    box-shadow: none;
}
.game-row-poki {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
}
.game-card-poki {
    width: 110px;
    height: 110px;
    position: relative;
    cursor: pointer;
    transform-style: preserve-3d;
    transition: transform 0.3s;
    margin: 0;
}
.game-card-poki.flipped {
    transform: rotateY(180deg);
}
.game-card-poki.matched {
    opacity: 0.4;
    pointer-events: none;
}
.card-front-poki, .card-back-poki {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    border: 2px solid #fff;
    font-size: 1.1em;
    margin: 0;
    box-shadow: 0 2px 12px rgba(162,89,255,0.10);
}
.card-back-poki {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transform: rotateY(0deg);
}
.card-front-poki {
    background: var(--card-color);
    transform: rotateY(180deg);
    font-size: 1em;
    text-align: center;
    padding: 2px;
}
.game-bar-poki {
    background: rgba(255,255,255,0.85);
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(44,62,80,0.07);
    padding: 6px 18px 4px 18px;
    min-width: 320px;
    max-width: 90vw;
}
.stat-poki {
    min-width: 48px;
    text-align: center;
    font-weight: 700;
    font-size: 1.05em;
    color: #22223B;
}
.stat-poki-label {
    font-size: 0.82em;
    color: #888;
    font-weight: 500;
    margin-top: -2px;
}
.poki-btn {
    border-radius: 10px !important;
    font-weight: 700;
    font-size: 1.1em;
    padding: 0.3rem 0.7rem;
    margin: 0 0.1rem;
    box-shadow: 0 1px 4px rgba(44,62,80,0.07);
}
.level-title-poki {
    position: absolute;
    top: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(162,89,255,0.13);
    color: #A259FF;
    font-size: 1.1rem;
    font-weight: 800;
    padding: 4px 18px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(162,89,255,0.07);
    z-index: 2;
    letter-spacing: 0.02em;
}
.level-title-poki.level-title-prominent {
    position: relative;
    top: 0;
    left: 0;
    transform: none;
    background: rgba(162,89,255,0.18);
    color: #7b2ff2;
    font-size: 2.1rem;
    font-weight: 900;
    padding: 0.6rem 2.5rem;
    border-radius: 18px;
    box-shadow: 0 2px 12px rgba(162,89,255,0.10);
    margin: 1.2rem auto 1.2rem auto;
    text-align: center;
    letter-spacing: 0.03em;
    z-index: 2;
    width: fit-content;
    min-width: 180px;
}
.poki-modal-content {
    border-radius: 1.5rem;
    background: #fff;
    box-shadow: 0 4px 32px rgba(162,89,255,0.13);
    border: 2px solid #A259FF;
}
.poki-modal-dialog {
    max-width: 340px;
    min-width: 0;
    margin: 0 auto;
}
.poki-modal-content-compact {
    border-radius: 1.1rem;
    background: #fff;
    box-shadow: 0 2px 18px rgba(162,89,255,0.13);
    border: 2px solid #A259FF;
    padding: 0 0.5rem;
}
.poki-modal-stats {
    font-size: 0.98rem;
    font-weight: 700;
    margin-bottom: 0.2rem;
}
.poki-modal-score {
    font-size: 1.08rem;
    font-weight: 800;
    color: #58CC02;
    margin-bottom: 0.1rem;
}
.poki-modal-content-compact .modal-header,
.poki-modal-content-compact .modal-footer {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}
.poki-modal-content-compact .modal-footer {
    padding-top: 0.2rem;
    padding-bottom: 0.5rem;
}
.stat-poki-group {
    flex-wrap: wrap;
}
.stat-poki {
    min-width: 60px;
    text-align: center;
    font-weight: 700;
    font-size: 1.05em;
    color: #22223B;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.stat-poki-label {
    font-size: 0.82em;
    color: #888;
    font-weight: 500;
    margin-bottom: 2px;
}
.poki-modal-stats {
    flex-direction: row !important;
    gap: 2.5rem !important;
}
.poki-modal-stat-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 80px;
}
.gameover-modal-responsive {
    max-width: 98vw;
    width: 100%;
    margin: 0 auto;
}
.poki-modal-content-compact {
    max-width: 400px;
    width: 100%;
    margin: 0 auto;
    border-radius: 1.1rem;
    background: #fff;
    box-shadow: 0 2px 18px rgba(162,89,255,0.13);
    border: 2px solid #A259FF;
    padding: 0 0.5rem;
}
.gameover-modal-fullwidth {
    max-width: 100vw !important;
    width: 100vw !important;
    margin: 0;
}
.poki-modal-content-fullwidth {
    width: 100vw !important;
    max-width: 100vw !important;
    min-width: 0;
    border-radius: 1.1rem;
    background: #fff;
    box-shadow: 0 2px 18px rgba(162,89,255,0.13);
    border: 2px solid #A259FF;
    padding: 0;
}
.gameover-modal-row {
    min-height: 140px;
    width: 100%;
    gap: 1.5rem;
}
.gameover-modal-icon {
    min-width: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.gameover-modal-message {
    min-width: 180px;
    max-width: 320px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.3rem !important;
}
.gameover-modal-stats {
    min-width: 120px;
    max-width: 160px;
    font-size: 1.05em;
    justify-content: center;
    gap: 2.2rem !important;
    margin-bottom: 0.5rem !important;
}
.gameover-modal-actions {
    min-width: 110px;
    max-width: 140px;
    justify-content: center;
    gap: 0.7rem !important;
}
.gameover-modal-centered-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    min-height: 140px;
    padding: 1.5rem 0.5rem 1.2rem 0.5rem;
}
.gameover-modal-stats {
    width: 100%;
    justify-content: center;
}
.gameover-modal-header {
    background: linear-gradient(90deg, #58CC02 0%, #A259FF 100%);
    color: #fff;
    min-height: 60px;
    border-top-left-radius: 1.1rem;
    border-top-right-radius: 1.1rem;
    box-shadow: 0 2px 8px rgba(88,204,2,0.10), 0 1.5px 0 #A259FF inset;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
    border-bottom: none !important;
    margin-bottom: 0;
}
.gameover-header-icon {
    font-size: 2rem;
    color: #FFD600;
    display: flex;
    align-items: center;
    justify-content: center;
}
#modalTitle {
    font-size: 1.3rem;
    font-weight: 900;
    letter-spacing: 0.02em;
    color: #fff;
    margin-bottom: 0;
}
.gameover-modal-body-enhanced {
    padding: 2.2rem 1.2rem 1.5rem 1.2rem !important;
    min-height: 180px;
}
.poki-modal-content-fullwidth.gameover-modal-blend {
    background: #fff;
    border: none !important;
    border-bottom-left-radius: 1.1rem;
    border-bottom-right-radius: 1.1rem;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    box-shadow: 0 6px 32px rgba(162,89,255,0.10), 0 1.5px 0 #A259FF inset;
    margin-top: 0;
}
.gameover-inline-section {
    background: linear-gradient(135deg, #e0f7fa 0%, #f3e7ff 100%);
    border-radius: 1.1rem;
    box-shadow: 0 4px 24px rgba(162,89,255,0.10);
    /* border: 2px solid #A259FF; */
    max-width: 500px;
    width: 95vw;
    margin: 2rem auto 0 auto;
    padding: 1.2rem 1.2rem 1rem 1.2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10;
    gap: 0.7rem;
}
@media (max-width: 700px) {
    .gameover-inline-heading {
        font-size: 1.2rem;
        padding: 0.2rem 1.1rem;
    }
}
@media (max-width: 900px) {
    .gameover-modal-body-enhanced .row { flex-direction: column !important; }
    .gameover-modal-body-enhanced { padding: 1.2rem 0.2rem 1.2rem 0.2rem !important; }
    .gameover-modal-stats { gap: 1.2rem !important; }
}
@media (max-width: 600px) {
    .poki-modal-content-compact {
        max-width: 98vw;
        width: 100vw;
        padding: 0 0.1rem;
    }
}
</style>

<script>
// Game variables
let gameState = {
    cards: [],
    flippedCards: [],
    matchedPairs: 0,
    totalAttempts: 0,
    score: 0,
    gameStarted: false,
    gamePaused: false,
    timeRemaining: {{ level.time_limit }},
    timer: null,
    sessionId: {{ session.id }}
};

// Initialize game
document.addEventListener('DOMContentLoaded', function() {
    initializeGame();
    setupEventListeners();
});

function initializeGame() {
    // Get all cards
    const cardElements = document.querySelectorAll('.game-card-poki');
    gameState.cards = Array.from(cardElements).map(card => ({
        element: card,
        id: card.dataset.cardId,
        color: card.dataset.color,
        name: card.dataset.name,
        isFlipped: false,
        isMatched: false
    }));
    
    // Set CSS custom properties for colors
    gameState.cards.forEach(card => {
        card.element.style.setProperty('--card-color', card.color);
    });
}

function setupEventListeners() {
    // Card click events
    gameState.cards.forEach(card => {
        card.element.addEventListener('click', () => handleCardClick(card));
    });
    
    // Button events
    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('pauseBtn').addEventListener('click', togglePause);
    document.getElementById('resetBtn').addEventListener('click', resetGame);
    document.getElementById('playAgainBtn').addEventListener('click', () => {
        document.getElementById('gameoverInlineSection').classList.remove('d-none');
        document.getElementById('gameOverModal').classList.add('d-none');
        resetGame();
    });
    document.getElementById('closeInlineGameoverBtn').addEventListener('click', () => {
        document.getElementById('gameoverInlineSection').classList.add('d-none');
        document.getElementById('gameOverModal').classList.add('d-none');
        resetGame();
    });
    document.getElementById('playAgainInlineBtn').addEventListener('click', () => {
        document.getElementById('gameoverInlineSection').classList.add('d-none');
        document.getElementById('gameOverModal').classList.add('d-none');
        resetGame();
    });
}

function handleCardClick(card) {
    if (!gameState.gameStarted || gameState.gamePaused || card.isFlipped || card.isMatched) {
        return;
    }
    
    // Flip the card
    flipCard(card);
    
    // Add to flipped cards
    gameState.flippedCards.push(card);
    
    // Check if we have two cards flipped
    if (gameState.flippedCards.length === 2) {
        gameState.totalAttempts++;
        updateStats();
        
        const card1 = gameState.flippedCards[0];
        const card2 = gameState.flippedCards[1];
        
        if (card1.color === card2.color) {
            // Match found!
            setTimeout(() => {
                markAsMatched(card1, card2);
                gameState.matchedPairs++;
                gameState.score += 10;
                updateStats();
                
                // Check if level is complete
                if (gameState.matchedPairs >= {{ level.required_matches }}) {
                    setTimeout(() => {
                        endGame(true);
                    }, 500);
                }
            }, 500);
        } else {
            // No match
            setTimeout(() => {
                flipCard(card1);
                flipCard(card2);
            }, 1000);
        }
        
        gameState.flippedCards = [];
    }
}

function flipCard(card) {
    card.isFlipped = !card.isFlipped;
    card.element.classList.toggle('flipped');
}

function markAsMatched(card1, card2) {
    card1.isMatched = true;
    card2.isMatched = true;
    card1.element.classList.add('matched');
    card2.element.classList.add('matched');
}

function startGame() {
    if (gameState.gameStarted) return;
    
    gameState.gameStarted = true;
    gameState.gamePaused = false;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('pauseBtn').disabled = false;
    
    // Start timer
    gameState.timer = setInterval(() => {
        if (!gameState.gamePaused) {
            gameState.timeRemaining--;
            document.getElementById('timer').textContent = gameState.timeRemaining;
            
            if (gameState.timeRemaining <= 0) {
                endGame(false);
            }
        }
    }, 1000);
}

function togglePause() {
    gameState.gamePaused = !gameState.gamePaused;
    const pauseBtn = document.getElementById('pauseBtn');
    if (gameState.gamePaused) {
        pauseBtn.innerHTML = '<i class="fas fa-play me-2"></i>Resume';
        pauseBtn.classList.remove('btn-warning');
        pauseBtn.classList.add('btn-success');
    } else {
        pauseBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
        pauseBtn.classList.remove('btn-success');
        pauseBtn.classList.add('btn-warning');
    }
}

function resetGame() {
    // Clear timer
    if (gameState.timer) {
        clearInterval(gameState.timer);
    }
    
    // Reset game state
    gameState = {
        cards: gameState.cards,
        flippedCards: [],
        matchedPairs: 0,
        totalAttempts: 0,
        score: 0,
        gameStarted: false,
        gamePaused: false,
        timeRemaining: {{ level.time_limit }},
        timer: null,
        sessionId: {{ session.id }}
    };
    
    // Reset UI
    gameState.cards.forEach(card => {
        card.isFlipped = false;
        card.isMatched = false;
        card.element.classList.remove('flipped', 'matched');
    });
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('pauseBtn').disabled = true;
    document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
    document.getElementById('pauseBtn').classList.remove('btn-success');
    document.getElementById('pauseBtn').classList.add('btn-warning');
    
    document.getElementById('timer').textContent = gameState.timeRemaining;
    updateStats();
}

function updateStats() {
    document.getElementById('score').textContent = gameState.score;
    document.getElementById('matches').textContent = gameState.matchedPairs;
    document.getElementById('attempts').textContent = gameState.totalAttempts;
    
    const accuracy = gameState.totalAttempts > 0 ? 
        Math.round((gameState.matchedPairs / gameState.totalAttempts) * 100) : 0;
    document.getElementById('accuracy').textContent = accuracy + '%';
}

function endGame(won) {
    if (gameState.timer) {
        clearInterval(gameState.timer);
    }
    
    gameState.gameStarted = false;
    
    const accuracy = gameState.totalAttempts > 0 ? 
        Math.round((gameState.matchedPairs / gameState.totalAttempts) * 100) : 0;
    
    // Update modal
    const modal = document.getElementById('gameOverModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalIcon = document.getElementById('modalIcon');
    const modalMessage = document.getElementById('modalMessage');
    const modalDetails = document.getElementById('modalDetails');
    
    if (won) {
        modalTitle.textContent = 'Level Complete!';
        modalIcon.innerHTML = '<i class="fas fa-trophy fa-3x text-success"></i>';
        modalMessage.textContent = 'Congratulations!';
        modalDetails.textContent = 'You completed the level successfully!';
    } else {
        modalTitle.textContent = 'Time\'s Up!';
        modalIcon.innerHTML = '<i class="fas fa-clock fa-3x text-warning"></i>';
        modalMessage.textContent = 'Game Over';
        modalDetails.textContent = 'Time ran out. Try again!';
    }
    
    document.getElementById('modalScore').textContent = gameState.score;
    document.getElementById('modalAccuracy').textContent = accuracy + '%';
    
    // Show modal
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Save game result
    saveGameResult(won, accuracy);
}

function saveGameResult(won, accuracy) {
    const timeTaken = {{ level.time_limit }} - gameState.timeRemaining;
    
    fetch('{% url "games:save_result" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            session_id: gameState.sessionId,
            score: gameState.score,
            time_taken: timeTaken,
            matches_found: gameState.matchedPairs,
            total_attempts: gameState.totalAttempts,
            completed: won
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Game result saved successfully');
        } else {
            console.error('Error saving game result:', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving game result:', error);
    });
}
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %} 